<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Slip Verifier</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      max-width: 800px;
      margin: auto;
      background-color: #f9fafc;
      color: #333;
    }
    h1 {
      color: #1a73e8;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    button:hover {
      background-color: #0f5fc0;
    }
    .instrucciones {
      background-color: #eef3fa;
      padding: 15px 25px;
      border-left: 5px solid #1a73e8;
      border-radius: 5px;
      margin-top: 20px;
    }
    ol {
      margin: 0;
      padding-left: 20px;
    }
  </style>
</head>
<body>

  <h1>üìÑ Script: Slip Verifier</h1>
<p>Click the button below to copy the script, then paste it into Excel Online.</p>

<button onclick="copiarScript()">üìã Copy Script</button>

  <!-- üîí Script oculto, pero accesible desde JS -->
  <textarea id="codigo" style="display:none;">
function main(workbook: ExcelScript.Workbook) {
  const startTime = new Date().getTime();
  let totalMatches = 0;
  let keywordCount: { [key: string]: number } = {};
  let matchDetails: { word: string; sheet: string; cell: string }[] = [];
  let markOnlyMode = false;
  let protectedCellsWarningShown = false;

  // Check if new sheets can be created
  try {
    const testSheet = workbook.addWorksheet("TEMP_SCRIPT_CHECK");
    testSheet.delete();
  } catch (e) {
    markOnlyMode = true;
    console.log("‚òÉ Cannot create sheets - file is macro-enabled or protected");
  }

  // Product list (anonymized)
  const products = [
    { name: "Product A", category: "CAT-01", keywords: ["option", "benefit", "package"] },
    { name: "Product B", category: "CAT-02", keywords: ["excess", "additional"] },
    { name: "Service C", category: "CAT-03", keywords: ["assistance", "support", "care"] },
    { name: "Coverage D", category: "CAT-04", keywords: ["basic", "extended", "premium"] },
    { name: "Plan E", category: "CAT-05", keywords: ["holder", "dependent", "family"] },
    { name: "Addon F", category: "CAT-06", keywords: ["optional", "extra"] },
    { name: "Benefit G", category: "CAT-07", keywords: ["burial", "funeral", "funeral assistance"] }
  ];

  // Preprocess keywords to lowercase
  const processedProducts = products.map(p => ({
    ...p,
    keywords: p.keywords.map(k => k.toLowerCase())
  }));

  // Create sheets if possible
  let resultSheet: ExcelScript.Worksheet | null = null;
  let summarySheet: ExcelScript.Worksheet | null = null;

  if (!markOnlyMode) {
    const existingResult = workbook.getWorksheet("Results");
    if (existingResult) existingResult.delete();

    const existingSummary = workbook.getWorksheet("Summary");
    if (existingSummary) existingSummary.delete();

    try {
      resultSheet = workbook.addWorksheet("Results");
      resultSheet.getRange("A1:E1").setValues([["Product", "Category", "Keyword", "Sheet", "Cell"]]);
    } catch {}

    try {
      summarySheet = workbook.addWorksheet("Summary");
    } catch {}
  }

  const sheets = workbook.getWorksheets();
  let rowIndex = 2;

  for (let sheet of sheets) {
    if (
      sheet.getName() === "Results" ||
      sheet.getName() === "Summary" ||
      sheet.getVisibility() !== ExcelScript.SheetVisibility.visible
    ) continue;

    const range = sheet.getUsedRange();
    if (!range) continue;

    const values = range.getValues();

    const hiddenRows: boolean[] = [...Array(range.getRowCount()).keys()].map(i =>
      range.getCell(i, 0).getRow().getHidden()
    );
    const hiddenColumns: boolean[] = [...Array(range.getColumnCount()).keys()].map(j =>
      range.getCell(0, j).getColumn().getHidden()
    );

    for (let i = 0; i < values.length; i++) {
      if (hiddenRows[i]) continue;

      for (let j = 0; j < values[i].length; j++) {
        if (hiddenColumns[j]) continue;

        const rawValue = values[i][j];
        const cellValue = String(rawValue).trim().toLowerCase();
        if (!cellValue) continue;

        const cell = range.getCell(i, j);

        for (let product of processedProducts) {
          for (let keyword of product.keywords) {
            if (cellValue.includes(keyword)) {
              totalMatches++;
              matchDetails.push({
                word: keyword,
                sheet: sheet.getName(),
                cell: cell.getAddress()
              });
              keywordCount[keyword] = (keywordCount[keyword] || 0) + 1;

              if (!markOnlyMode) {
                try {
                  const originalText = String(cell.getValue());
                  const regex = new RegExp(`\\b(${keyword})\\b`, "gi");
                  const highlightedText = originalText.replace(regex, "‚ò¢$1‚ò¢");
                  cell.setValue(highlightedText);
                  try {
                    cell.getFormat().getFill().setColor("aqua");
                  } catch {}
                } catch (e) {
                  if (!protectedCellsWarningShown) {
                    protectedCellsWarningShown = true;
                    console.log("‚ö† Some cells are protected or cannot be modified.");
                  }
                }

                if (resultSheet) {
                  const address = cell.getAddressLocal();
                  resultSheet.getCell(rowIndex - 1, 0).setValue(product.name);
                  resultSheet.getCell(rowIndex - 1, 1).setValue(product.category);
                  resultSheet.getCell(rowIndex - 1, 2).setValue(keyword);
                  resultSheet.getCell(rowIndex - 1, 3).setValue(sheet.getName());
                  resultSheet.getCell(rowIndex - 1, 4).setValue(address);
                  rowIndex++;
                }
              }
            }
          }
        }
      }
    }
  }

  const endTime = new Date().getTime();
  const seconds = Math.round((endTime - startTime) / 1000);

  if (!markOnlyMode && summarySheet) {
    summarySheet.getCell(0, 0).setValue("‚úÖ Script executed successfully");
    summarySheet.getCell(1, 0).setValue(`Execution Time: ${seconds} seconds`);
    summarySheet.getCell(2, 0).setValue(`Total Matches: ${totalMatches}`);
    summarySheet.getCell(3, 0).setValue("Keyword Match Count:");

    let summaryRow = 4;
    for (const keyword in keywordCount) {
      summarySheet.getCell(summaryRow, 0).setValue(`${keyword}: ${keywordCount[keyword]}`);
      summaryRow++;
    }
  }

  if (markOnlyMode) {
    console.log("Summary (‚Ä¢œâ‚Ä¢)");
    console.log(`Execution Time: ${seconds} seconds`);
    console.log(`Total Matches: ${totalMatches}`);
    console.log("Keyword Match Count:");
    console.log(JSON.stringify(keywordCount, null, 2));
    console.log("Keyword Match Details:");
    console.log(JSON.stringify(matchDetails, null, 2));
  }
}


  </textarea>

  <div class="instrucciones">
    <h3>üß≠ Instrucciones:</h3>
    <ol>
    <li>Open <strong>Excel Online</strong>.</li>
    <li>Go to the <strong>Automate</strong> tab &gt; <strong>New Script</strong>.</li>
    <li>Paste the copied script (<kbd>Ctrl</kbd> + <kbd>V</kbd>).</li>
    <li>Save it as <strong>VerificadorSlip</strong>.</li>
    </ol>
  </div>

  <script>
    function copiarScript() {
      const texto = document.getElementById("codigo").value;
      navigator.clipboard.writeText(texto).then(() => {
        alert("‚úÖScript copied to clipboard!");
      }).catch(err => {
        alert("‚ùå Error al copiar: " + err);
      });
    }
  </script>

</body>
</html>


